<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Bus Details - TMO Shuttle Services</title>
    <style>
        /* existing styles remain unchanged */
    </style>
</head>
<body>

<h1>TMO Shuttle Services Integrated Management System</h1>
<h2>Edit Bus Details</h2>

<!-- Search Bar and Back Button -->
<div class="search-container">
    <input type="text" id="searchBar" placeholder="Search for a bus..." onkeyup="searchBusDetails()">
    <button class="back-button" onclick="goBack()">Back</button>
</div>

<!-- Existing Bus Details Table -->
<table>
    <thead>
        <tr>
            <th>Id No</th>
            <th>Bus No</th>
            <th>In/Out</th>
            <th>Company</th>
            <th>Date</th>
            <th>Price</th>
            <th>Seat No</th>
            <th>Time</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="busTableBody">
        <!-- Rows will be populated by JavaScript -->
    </tbody>
</table>

<!-- Overlay for the modal -->
<div class="overlay" id="modalOverlay"></div>

<!-- Modal Form for Editing Bus Details -->
<div class="modal" id="editBusDetailsForm">
    <h3>Edit Bus Details</h3>
    <input type="hidden" id="editBusId">
    
    <label for="editBusNo">Bus No:</label>
    <input type="text" id="editBusNo" required>
    
    <label for="editInOut">In/Out:</label>
    <select id="editInOut" required>
        <option value="In">In</option>
        <option value="Out">Out</option>
    </select>

    <label for="editCompany">Company:</label>
    <input type="text" id="editCompany" required>

    <label for="editDate">Date:</label>
    <input type="date" id="editDate" required>

    <label for="editPrice">Price:</label>
    <input type="number" id="editPrice" required>

    <label for="editSeatNo">Seat No:</label>
    <input type="text" id="editSeatNo" required>

    <label for="editTime">Time:</label>
    <input type="text" id="editTime" required placeholder="hh:mm AM/PM">

    <button id="updateBusDetails" onclick="updateBusDetails()">Update</button>
    <button id="cancelEdit" class="cancel-button" onclick="closeEditModal()">Cancel</button>
</div>

<script>
// Function to populate the bus table with details from local storage
function populateBusTable() {
    const busList = JSON.parse(localStorage.getItem('busList')) || [];
    const tableBody = document.getElementById('busTableBody');
    tableBody.innerHTML = '';

    // Create rows from the bus details
    busList.forEach((bus, index) => {
        const row = document.createElement('tr');
        row.setAttribute('data-id', index + 1);
        row.innerHTML = `
            <td>${bus.idNo}</td>
            <td>${bus.busNo}</td>
            <td>${bus.inOut}</td>
            <td>${bus.company}</td>
            <td>${bus.date}</td>
            <td>$${bus.price}</td>
            <td>${bus.seatNo}</td>
            <td>${bus.time}</td>
            <td>
                <button onclick="editBusDetails(${index})">Edit</button>
                <button onclick="confirmDeleteBusDetails(${index})">Delete</button>
            </td>
        `;
        tableBody.appendChild(row);
    });

    // Update aggregated counts
    updateAggregatedCounts(busList);
}

// Function to update aggregated counts
function updateAggregatedCounts(busList) {
    const totalBuses = busList.length;
    const totalIn = busList.filter(bus => bus.inOut === 'In').length;
    const totalOut = busList.filter(bus => bus.inOut === 'Out').length;

    localStorage.setItem('totalBusCount', totalBuses);
    localStorage.setItem('totalBusesIn', totalIn);
    localStorage.setItem('totalBusesOut', totalOut);
}

// Function to update bus details
function updateBusDetails() {
    const index = parseInt(document.getElementById('editBusId').value);
    const busList = JSON.parse(localStorage.getItem('busList'));

    // Update the bus object
    busList[index].busNo = document.getElementById('editBusNo').value;
    busList[index].inOut = document.getElementById('editInOut').value;
    busList[index].company = document.getElementById('editCompany').value;
    busList[index].date = document.getElementById('editDate').value;
    busList[index].price = document.getElementById('editPrice').value;
    busList[index].seatNo = document.getElementById('editSeatNo').value;
    busList[index].time = document.getElementById('editTime').value;

    // Save updated bus list to local storage
    localStorage.setItem('busList', JSON.stringify(busList));
    
    // Update aggregate data count
    updateAggregatedCounts(busList);
    
    // Close modal and refresh table
    closeEditModal();
    populateBusTable();
    alert("Changes have been made successfully.");
}

function searchBusDetails() {
    const searchValue = document.getElementById('searchBar').value.toLowerCase();
    const rows = document.querySelectorAll('#busTableBody tr');
    rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        let found = false;
        for (let i = 0; i < cells.length; i++) {
            if (cells[i].innerText.toLowerCase().includes(searchValue)) {
                found = true;
                break;
            }
        }
        row.style.display = found ? '' : 'none';
    });
}

function editBusDetails(index) {
    const busList = JSON.parse(localStorage.getItem('busList')) || [];
    const bus = busList[index];

    // Populate the modal with current bus details
    document.getElementById('editBusId').value = index;
    document.getElementById('editBusNo').value = bus.busNo;
    document.getElementById('editInOut').value = bus.inOut;
    document.getElementById('editCompany').value = bus.company;
    document.getElementById('editDate').value = bus.date;
    document.getElementById('editPrice').value = bus.price;
    document.getElementById('editSeatNo').value = bus.seatNo;
    document.getElementById('editTime').value = bus.time;

    // Show modal and overlay
    document.getElementById('editBusDetailsForm').style.display = 'block';
    document.getElementById('modalOverlay').style.display = 'block';
}

// Close edit modal
function closeEditModal() {
    document.getElementById('editBusDetailsForm').style.display = 'none';
    document.getElementById('modalOverlay').style.display = 'none';
}

// Confirm delete bus details
function confirmDeleteBusDetails(index) {
    const confirmation = confirm("Are you sure you want to delete this bus record?");
    if (confirmation) {
        const busList = JSON.parse(localStorage.getItem("busList"));
        busList.splice(index, 1); // Remove bus from the array
        localStorage.setItem("busList", JSON.stringify(busList)); // Update local storage
        populateBusTable(); // Refresh table
        updateAggregatedCounts(busList); // Update aggregate counts
        alert("Bus record has been deleted successfully.");
    }
}

document.addEventListener("DOMContentLoaded", populateBusTable); // Call populateBusTable on page load
</script>

</body>
</html>